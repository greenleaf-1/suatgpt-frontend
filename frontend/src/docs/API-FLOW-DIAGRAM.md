# API äº¤äº’æµç¨‹å›¾ - AIæ¨¡å‹åˆ‡æ¢åŠŸèƒ½

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·æ“ä½œæµç¨‹                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ç”¨æˆ·æ‰“å¼€èŠå¤©ç•Œé¢
        â”‚
        â”œâ”€â†’ åŠ è½½å†å²è®°å½• (GET /api/ai/chat/history)
        â”‚
2. ç”¨æˆ·é€‰æ‹©AIæ¨¡å‹
        â”‚
        â”œâ”€â†’ [é»˜è®¤] ğŸ« Qwen (å†…ç½‘) â†’ modelKey: "qwen-internal"
        â”‚
        â””â”€â†’ [æ–°å¢] ğŸŒ Qwen (å…¬ç½‘) â†’ modelKey: "qwen-public"
        â”‚
3. ç”¨æˆ·è¾“å…¥æ¶ˆæ¯å¹¶å‘é€
        â”‚
        â””â”€â†’ å‘é€è¯·æ±‚åˆ°åç«¯


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å‰ç«¯ â†’ åç«¯ è¯·æ±‚æµç¨‹                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å‰ç«¯ (React)                      åç«¯ (Java Spring Boot)
    â”‚                                      â”‚
    â”‚  1. è·å–JWT Token                     â”‚
    â”‚     localStorage.getItem('authToken') â”‚
    â”‚                                      â”‚
    â”‚  2. æ„å»ºè¯·æ±‚                          â”‚
    â”‚     {                                â”‚
    â”‚       content: "ç”¨æˆ·æ¶ˆæ¯",            â”‚
    â”‚       modelKey: "qwen-internal"      â”‚
    â”‚     }                                â”‚
    â”‚                                      â”‚
    â”‚  3. å‘é€HTTPè¯·æ±‚                      â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚
    â”‚     POST /api/ai/chat                â”‚  4. æ¥æ”¶è¯·æ±‚
    â”‚     Headers:                         â”‚     â””â†’ éªŒè¯JWT Token
    â”‚       Authorization: Bearer <token>  â”‚     â””â†’ è§£æè¯·æ±‚ä½“
    â”‚       Content-Type: application/json â”‚     â””â†’ è·å– content & modelKey
    â”‚     Body:                            â”‚
    â”‚       { content, modelKey }          â”‚  5. è·¯ç”±åˆ°AIæœåŠ¡
    â”‚                                      â”‚     â””â†’ if (modelKey == "qwen-internal")
    â”‚                                      â”‚           è°ƒç”¨å†…ç½‘AI
    â”‚                                      â”‚     â””â†’ else if (modelKey == "qwen-public")
    â”‚                                      â”‚           è°ƒç”¨å…¬ç½‘AI
    â”‚                                      â”‚
    â”‚                                      â”‚  6. è·å–AIå“åº”
    â”‚                                      â”‚     â””â†’ AIå›å¤å†…å®¹
    â”‚                                      â”‚
    â”‚  8. æ¥æ”¶å“åº”                          â”‚  7. æ„å»ºå“åº”
    â”‚  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚     {
    â”‚     {                                â”‚       success: true,
    â”‚       success: true,                 â”‚       content: "AIå›å¤",
    â”‚       content: "AIå›å¤",              â”‚       timestamp: "..."
    â”‚       timestamp: "..."               â”‚     }
    â”‚     }                                â”‚
    â”‚                                      â”‚
    â”‚  9. æ›´æ–°UI                            â”‚
    â”‚     â””â†’ æ˜¾ç¤ºAIæ¶ˆæ¯                     â”‚
    â”‚     â””â†’ ä¿å­˜åˆ°èŠå¤©å†å²                 â”‚
    â”‚                                      â”‚
```

---

## ğŸ” è¯¦ç»†è¯·æ±‚ç¤ºä¾‹

### ç¤ºä¾‹ 1: ä½¿ç”¨å†…ç½‘æ¨¡å‹

#### å‰ç«¯ä»£ç 
```typescript
// AIChat.tsx
const handleSend = async () => {
  const userInput = "ä»€ä¹ˆæ˜¯Javaå¤šæ€ï¼Ÿ";
  const modelKey = "qwen-internal"; // ç”¨æˆ·é€‰æ‹©äº†å†…ç½‘æ¨¡å‹
  
  const response = await sendChatMessage(userInput, modelKey);
};
```

#### HTTPè¯·æ±‚
```http
POST http://localhost:8080/api/ai/chat HTTP/1.1
Host: localhost:8080
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiIyMDIzMDAxIiwiaWF0IjoxNjk5MjAwMDAwfQ.xyz123

{
  "content": "ä»€ä¹ˆæ˜¯Javaå¤šæ€ï¼Ÿ",
  "modelKey": "qwen-internal"
}
```

#### åç«¯å¤„ç†
```java
@PostMapping("/chat")
public ResponseEntity<ChatResponse> chat(
    @RequestHeader("Authorization") String token,
    @RequestBody ChatRequest request
) {
    // 1. éªŒè¯Token
    String jwt = token.replace("Bearer ", "");
    User user = jwtService.validateToken(jwt); // éªŒè¯é€šè¿‡
    
    // 2. è·å–å‚æ•°
    String content = request.getContent();      // "ä»€ä¹ˆæ˜¯Javaå¤šæ€ï¼Ÿ"
    String modelKey = request.getModelKey();    // "qwen-internal"
    
    // 3. è°ƒç”¨å†…ç½‘AI
    String aiResponse = internalAIService.chat(content);
    // AIå›å¤: "Javaå¤šæ€æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹çš„ä¸‰å¤§ç‰¹æ€§ä¹‹ä¸€..."
    
    // 4. è¿”å›å“åº”
    return ResponseEntity.ok(new ChatResponse(true, aiResponse));
}
```

#### HTTPå“åº”
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "success": true,
  "content": "Javaå¤šæ€æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹çš„ä¸‰å¤§ç‰¹æ€§ä¹‹ä¸€ï¼Œå®ƒå…è®¸ä¸åŒç±»çš„å¯¹è±¡å¯¹åŒä¸€æ¶ˆæ¯åšå‡ºå“åº”...",
  "timestamp": "2024-12-03T10:30:00Z"
}
```

---

### ç¤ºä¾‹ 2: åˆ‡æ¢åˆ°å…¬ç½‘æ¨¡å‹

#### å‰ç«¯æ“ä½œ
```typescript
// 1. ç”¨æˆ·ç‚¹å‡»åˆ‡æ¢æŒ‰é’®
<button onClick={() => setSelectedModel('qwen-public')}>
  ğŸŒ Qwen (å…¬ç½‘)
</button>

// 2. çŠ¶æ€æ›´æ–°
selectedModel = "qwen-public"

// 3. å‘é€æ¶ˆæ¯
const response = await sendChatMessage("ä»‹ç»ä¸€ä¸‹Spring Boot", "qwen-public");
```

#### HTTPè¯·æ±‚ï¼ˆæ³¨æ„ modelKey å˜åŒ–ï¼‰
```http
POST http://localhost:8080/api/ai/chat HTTP/1.1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

{
  "content": "ä»‹ç»ä¸€ä¸‹Spring Boot",
  "modelKey": "qwen-public"  â† è¿™é‡Œå˜äº†ï¼
}
```

#### åç«¯è·¯ç”±é€»è¾‘
```java
String modelKey = request.getModelKey(); // "qwen-public"

String aiResponse;
if ("qwen-internal".equals(modelKey)) {
    // å†…ç½‘æ¨¡å‹
    aiResponse = internalAIService.chat(content);
} else if ("qwen-public".equals(modelKey)) {
    // å…¬ç½‘æ¨¡å‹ â† æ‰§è¡Œè¿™ä¸ªåˆ†æ”¯
    aiResponse = publicAIService.chat(content);
} else {
    throw new IllegalArgumentException("ä¸æ”¯æŒçš„æ¨¡å‹: " + modelKey);
}
```

---

## ğŸ” JWTè®¤è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      JWTè®¤è¯æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ç”¨æˆ·ç™»å½•
   POST /api/auth/student/login
   {
     "studentId": "2023001",
     "password": "123456"
   }
        â”‚
        â†“
   åç«¯éªŒè¯æˆåŠŸï¼Œç”ŸæˆJWT Token
        â”‚
        â†“
   è¿”å›å“åº”:
   {
     "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
     "user": { ... }
   }
        â”‚
        â†“
2. å‰ç«¯ä¿å­˜Token
   localStorage.setItem('authToken', response.token)
   
        â”‚
        â†“
3. åç»­æ‰€æœ‰è¯·æ±‚æºå¸¦Token
   fetch('/api/ai/chat', {
     headers: {
       'Authorization': `Bearer ${token}`
     }
   })
        â”‚
        â†“
4. åç«¯éªŒè¯Token
   JwtAuthenticationFilter
   â””â†’ è§£æToken
   â””â†’ éªŒè¯ç­¾å
   â””â†’ æ£€æŸ¥è¿‡æœŸæ—¶é—´
   â””â†’ æå–ç”¨æˆ·ä¿¡æ¯
   â””â†’ è®¾ç½®SecurityContext
```

---

## ğŸ¯ æ ¸å¿ƒä»£ç å¯¹åº”å…³ç³»

### å‰ç«¯æ ¸å¿ƒæ–‡ä»¶
| æ–‡ä»¶ | åŠŸèƒ½ | å…³é”®ä»£ç  |
|------|------|---------|
| `/api/chat.ts` | APIå°è£… | `sendChatMessage(content, modelKey)` |
| `/components/AIChat.tsx` | UIç»„ä»¶ | `selectedModel` çŠ¶æ€ç®¡ç† |
| `/utils/api-config.ts` | é…ç½® | `BASE_URL`, `getHeaders()` |

### åç«¯æ ¸å¿ƒæ–‡ä»¶ï¼ˆéœ€è¦å®ç°ï¼‰
| æ–‡ä»¶ | åŠŸèƒ½ | å…³é”®ä»£ç  |
|------|------|---------|
| `AIChatController.java` | æ§åˆ¶å™¨ | `@PostMapping("/chat")` |
| `ChatRequest.java` | DTO | `content`, `modelKey` å­—æ®µ |
| `JwtAuthenticationFilter.java` | è®¤è¯ | TokenéªŒè¯é€»è¾‘ |
| `AIService.java` | AIæœåŠ¡ | è°ƒç”¨å†…ç½‘/å…¬ç½‘AI |

---

## ğŸ“ è¯·æ±‚/å“åº”æ•°æ®ç»“æ„

### è¯·æ±‚ä½“ (Request Body)
```typescript
interface ChatRequest {
  content: string;      // å¿…å¡«ï¼šç”¨æˆ·æ¶ˆæ¯
  modelKey: ModelKey;   // å¿…å¡«ï¼š'qwen-internal' | 'qwen-public'
}
```

### å“åº”ä½“ (Response Body)
```typescript
interface ChatResponse {
  success: boolean;     // å¿…å¡«ï¼šè¯·æ±‚æ˜¯å¦æˆåŠŸ
  content?: string;     // æˆåŠŸæ—¶ï¼šAIå›å¤å†…å®¹
  message?: string;     // å¤±è´¥æ—¶ï¼šé”™è¯¯ä¿¡æ¯
  timestamp?: string;   // å¯é€‰ï¼šæ—¶é—´æˆ³
}
```

---

## ğŸ”„ çŠ¶æ€æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯çŠ¶æ€ç®¡ç†                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆå§‹çŠ¶æ€
  â”‚
  â”œâ”€ selectedModel: 'qwen-internal'  (é»˜è®¤)
  â”œâ”€ messages: []
  â”œâ”€ inputValue: ''
  â””â”€ isAIThinking: false
  
        â”‚
        â†“
        
ç”¨æˆ·é€‰æ‹©æ¨¡å‹
  â”‚
  â””â†’ setSelectedModel('qwen-public')
  
        â”‚
        â†“
        
ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
  â”‚
  â””â†’ setInputValue('ä½ å¥½')
  
        â”‚
        â†“
        
ç”¨æˆ·ç‚¹å‡»å‘é€
  â”‚
  â”œâ†’ setIsAIThinking(true)
  â”œâ†’ æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ° messages
  â”œâ†’ æ¸…ç©º inputValue
  â””â†’ è°ƒç”¨ sendChatMessage(inputValue, selectedModel)
  
        â”‚
        â†“
        
ç­‰å¾…AIå“åº”
  â”‚
  â””â†’ æ˜¾ç¤º"AIæ­£åœ¨æ€è€ƒ..."
  
        â”‚
        â†“
        
æ”¶åˆ°å“åº”
  â”‚
  â”œâ†’ æ·»åŠ AIæ¶ˆæ¯åˆ° messages
  â””â†’ setIsAIThinking(false)
  
        â”‚
        â†“
        
å®Œæˆ (å›åˆ°åˆå§‹çŠ¶æ€ï¼Œç­‰å¾…ä¸‹æ¬¡è¾“å…¥)
```

---

## ğŸš¨ é”™è¯¯å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   é”™è¯¯å¤„ç†æœºåˆ¶                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å‰ç«¯å‘é€è¯·æ±‚
    â”‚
    â”œâ”€â†’ Tokenä¸å­˜åœ¨?
    â”‚   â””â†’ âŒ æŠ›å‡ºé”™è¯¯: "æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œï¼Œè¯·å…ˆç™»å½•"
    â”‚
    â”œâ”€â†’ ç½‘ç»œè¯·æ±‚å¤±è´¥?
    â”‚   â””â†’ âŒ æ˜¾ç¤º: "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"
    â”‚
    â”œâ”€â†’ åç«¯è¿”å›4xxé”™è¯¯?
    â”‚   â”œâ†’ 401: "æœªæˆæƒï¼Œè¯·é‡æ–°ç™»å½•"
    â”‚   â”œâ†’ 403: "æ— æƒé™è®¿é—®"
    â”‚   â””â†’ 400: "è¯·æ±‚å‚æ•°é”™è¯¯"
    â”‚
    â”œâ”€â†’ åç«¯è¿”å›5xxé”™è¯¯?
    â”‚   â””â†’ âŒ "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•"
    â”‚
    â””â”€â†’ å“åº”æ ¼å¼é”™è¯¯?
        â””â†’ âŒ "å“åº”æ•°æ®æ ¼å¼å¼‚å¸¸"

æ‰€æœ‰é”™è¯¯éƒ½ä¼šï¼š
  1. åœ¨æ§åˆ¶å°æ‰“å°è¯¦ç»†æ—¥å¿—
  2. åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºå‹å¥½æç¤º
  3. ä¸å½±å“å…¶ä»–åŠŸèƒ½ç»§ç»­ä½¿ç”¨
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å‰ç«¯ä¼˜åŒ–
1. **è¯·æ±‚é˜²æŠ–**: é˜²æ­¢ç”¨æˆ·å¿«é€Ÿè¿ç»­ç‚¹å‡»å‘é€
2. **æ¶ˆæ¯åˆ†é¡µ**: å†å²æ¶ˆæ¯è¿‡å¤šæ—¶åˆ†é¡µåŠ è½½
3. **ç¼“å­˜ç­–ç•¥**: ç¼“å­˜å¸¸è§é—®é¢˜çš„AIå›å¤

### åç«¯ä¼˜åŒ–
1. **Tokenç¼“å­˜**: é¿å…æ¯æ¬¡éƒ½è§£æJWT
2. **AIå“åº”ç¼“å­˜**: ç›¸åŒé—®é¢˜è¿”å›ç¼“å­˜ç»“æœ
3. **å¼‚æ­¥å¤„ç†**: AIè°ƒç”¨ä½¿ç”¨å¼‚æ­¥ï¼Œé¿å…é˜»å¡

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [å®Œæ•´å®ç°æŒ‡å—](./AI-MODEL-SWITCH-GUIDE.md)
- [å¿«é€Ÿæµ‹è¯•æŒ‡å—](./AI-QUICK-TEST.md)
- [åç«¯APIè§„èŒƒ](./BACKEND-API-SPEC.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2024-12-03  
**ç»´æŠ¤å›¢é˜Ÿ**: SUAT-GPT å¼€å‘ç»„
